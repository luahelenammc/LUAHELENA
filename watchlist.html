<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Watchlist — Debug</title>
  <style>
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0B1220; color:#EAF1FF; }
    .wrap{ max-width:980px; margin:24px auto; padding:0 14px; }
    .panel{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .pill{ padding:8px 10px; border-radius:999px; background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12); }
    .ok{ color:#34C759; font-weight:700; }
    .bad{ color:#FF3B30; font-weight:700; }
    .muted{ color:rgba(234,241,255,.7); }
    #cards{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:12px; }
    .card{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:14px; padding:12px; }
    @media (max-width:800px){ #cards{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 12px;">Watchlist — Diagnóstico</h1>

    <div class="panel">
      <div class="row">
        <div class="pill">Script carregou: <span id="sLoaded" class="muted">…</span></div>
        <div class="pill">Executou: <span id="sExec" class="muted">…</span></div>
        <div class="pill">Items: <span id="sCount" class="muted">…</span></div>
        <div class="pill">Último erro: <span id="sErr" class="muted">—</span></div>
      </div>
      <div class="muted" style="margin-top:10px;">
        Se “Script carregou” estiver OK mas “Executou” não, o problema costuma ser <b>MIME type/CSP</b>.
      </div>
    </div>

    <div id="cards"></div>
  </div>

  <!-- Carrega o watchlist.js com cache-buster -->
  <script
    src="/watchlist.js?v=20260111"
    onload="window.__WATCHLIST_SCRIPT_TAG_LOADED__=true"
    onerror="window.__WATCHLIST_SCRIPT_TAG_ERROR__=true"
  ></script>

  <script>
    // Captura erros JS e mostra na tela
    window.addEventListener("error", (e) => {
      const msg = e?.message || e?.error?.message || "erro desconhecido";
      document.getElementById("sErr").textContent = msg;
      document.getElementById("sErr").className = "bad";
    });

    function paintStatus() {
      const sLoaded = !!window.__WATCHLIST_SCRIPT_TAG_LOADED__ && !window.__WATCHLIST_SCRIPT_TAG_ERROR__;
      const sExec   = !!window.__WATCHLIST_JS_LOADED__;
      const count   = window.WATCHLIST_DATA?.items?.length;

      const elLoaded = document.getElementById("sLoaded");
      elLoaded.textContent = sLoaded ? "OK" : "NÃO";
      elLoaded.className = sLoaded ? "ok" : "bad";

      const elExec = document.getElementById("sExec");
      elExec.textContent = sExec ? "OK" : "NÃO";
      elExec.className = sExec ? "ok" : "bad";

      const elCount = document.getElementById("sCount");
      elCount.textContent = Number.isFinite(count) ? String(count) : "—";
      elCount.className = Number.isFinite(count) ? "ok" : "bad";
    }

    function renderCards() {
      const items = window.WATCHLIST_DATA?.items;
      if (!Array.isArray(items)) return;

      const cards = document.getElementById("cards");
      cards.innerHTML = "";
      for (const it of items) {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <div><b>${escapeHtml(it.title)}</b> <span class="muted">(${it.type})</span></div>
          <div class="muted">status: ${escapeHtml(it.status)} • progresso: ${Number(it.progress||0)}%</div>
          <div class="muted">tags: ${(it.tags||[]).map(t=>"#"+t).join(" ") || "—"}</div>
        `;
        cards.appendChild(div);
      }
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // Dá um tempinho pro onload do script externo marcar flags
    setTimeout(() => {
      paintStatus();
      renderCards();
    }, 60);
  </script>
</body>
</html>
