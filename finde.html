<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rel√≥gio ‚Äî sem linha interna</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0c0f; --muted:#cfd6dc; --dialBg:#0d1114;
    --greenStart:#004d2a; --greenEnd:#00ff77;
    --cyanStart:#00bfcf; --cyanEnd:#66ffff;
    --futureGrayStart:#e6e6e6; --futureGrayEnd:#a9a9a9;
    --sleepGrayStart:#eef2f6; --sleepGrayEnd:#c8cfd6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(180deg,#060609,#0d0f11); color:var(--muted); padding:28px;
  }
  .bezel{ width:760px; max-width:95vw; padding:22px; border-radius:18px;
    background:linear-gradient(180deg,#0f1316,#17191c); box-shadow:0 12px 40px rgba(0,0,0,0.7); position:relative; }
  .glass{ border-radius:12px; padding:18px; display:flex; gap:20px; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005)); backdrop-filter: blur(3px); position:relative; }
  .chart-wrap{width:420px;min-height:420px;display:flex;align-items:center;justify-content:center;padding:8px}
  .dial{width:400px;height:400px;border-radius:50%;background:linear-gradient(180deg,#071014,#0d1114);box-shadow:inset 0 18px 40px rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;position:relative}
  canvas{display:block;border-radius:50%; image-rendering: optimizeQuality; -webkit-font-smoothing:antialiased;}
  #sleepEmoji{
    position:absolute; top:50%; left:50%;
    font-size:34px; filter: drop-shadow(0 6px 10px rgba(0,0,0,0.6));
    opacity:0; pointer-events:none; transform: translate(-50%,-50%) scale(0.96);
    transition: opacity 180ms ease, transform 180ms ease; will-change:opacity, transform;
  }
  #sleepEmoji.visible{ opacity:1; transform: translate(-50%,-50%) scale(1); animation: sleepPulse 2.2s ease-in-out infinite; }
  @keyframes sleepPulse{ 0%{opacity:0.35} 50%{opacity:0.95} 100%{opacity:0.35} }
  .controls{width:280px;display:flex;flex-direction:column;gap:14px}
  .title{margin:0;font-size:20px;font-weight:600}
  .sub{margin:6px 0 0 0;font-size:12px;color:rgba(207,214,220,0.72)}
  .btn{padding:12px 16px;border-radius:12px;cursor:pointer;background:linear-gradient(180deg,#d7dbe0,#bfc6cc);box-shadow:0 6px 0 #6b6f73;border:1px solid rgba(0,0,0,0.15);font-weight:600}
  .link-salario{display:inline-block;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:600;color:var(--cyanEnd)}
  .meta{font-size:12px;color:rgba(207,214,220,0.6);display:flex;gap:8px;align-items:center}
  .legend-pill{display:inline-block;width:10px;height:10px;border-radius:50%;}
  @media (max-width:900px){ .glass{flex-direction:column;align-items:center} .chart-wrap{width:100%} .controls{width:100%} .dial{width:320px;height:320px} #sleepEmoji{font-size:28px} }
</style>
</head>
<body>

  <div class="bezel" role="region" aria-label="painel rel√≥gio">
    <div class="glass">
      <div class="chart-wrap">
        <div class="dial" id="dialRoot">
          <canvas id="myChart" width="400" height="400"></canvas>
          <div id="sleepEmoji" aria-hidden="true">üò¥</div>
        </div>
      </div>

      <div class="controls" role="group" aria-label="controles">
        <div><h1 class="title">Per√≠odo semanal ‚Äî in√≠cio: sex 17:00</h1><p class="sub">Zona de sono: dom 22:00 ‚Üí seg 08:00 ‚Ä¢ (cinza texturizado = pendente, ciano = dormido)</p></div>
        <div style="display:flex;gap:10px">
          <button class="btn" id="refreshBtn">‚ü≥ Refresh</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <a class="link-salario" href="/salario.html" target="_blank" rel="noopener">Ir para Sal√°rio</a>
          <div class="meta">
            <span class="legend-pill" style="background:linear-gradient(180deg,var(--greenStart),var(--greenEnd))"></span><small>Conclu√≠do (fora do sono)</small>
            <span class="legend-pill" style="background:linear-gradient(180deg,var(--cyanStart),var(--cyanEnd));margin-left:8px"></span><small>Atual / Dormido</small>
            <span class="legend-pill" style="background:linear-gradient(180deg,var(--sleepGrayStart),var(--sleepGrayEnd));margin-left:8px;border:1px solid rgba(0,0,0,0.08)"></span><small>Pendente (sono)</small>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){

  // helpers
  function pad(n){ return n<10?('0'+n):(''+n); }
  function fmtLabel(d){ var days=['Dom','Seg','Ter','Qua','Qui','Sex','Sab']; return days[d.getDay()]+' '+pad(d.getHours())+':'+pad(d.getMinutes()); }

  var now = new Date();
  var ctx = document.getElementById('myChart').getContext('2d');
  if (ctx && 'imageSmoothingEnabled' in ctx) ctx.imageSmoothingEnabled = true;
  var canvasEl = document.getElementById('myChart');

  // compute start / sleepStart / end
  function dateThisWeek(targetDay, hour, min){
    var base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour||0, min||0, 0, 0);
    var diff = targetDay - base.getDay();
    base.setDate(base.getDate() + diff);
    base.setHours(hour||0, min||0, 0, 0);
    return base;
  }
  var candidateStart = dateThisWeek(5,17,0);
  if(candidateStart > now) candidateStart.setDate(candidateStart.getDate() - 7);

  var daysUntilSunday = (0 - candidateStart.getDay() + 7) % 7;
  var sleepStart = new Date(candidateStart.getTime());
  sleepStart.setDate(candidateStart.getDate() + daysUntilSunday);
  sleepStart.setHours(22,0,0,0);

  function nextWeekdayAfter(baseDate, targetDay, hour, min){
    var d = new Date(baseDate.getTime());
    var diff = (targetDay + 7 - d.getDay()) % 7;
    if(diff === 0 && (d.getHours() > hour || (d.getHours()===hour && d.getMinutes()>=min))) diff = 7;
    d.setDate(d.getDate() + diff);
    d.setHours(hour||0,min||0,0,0);
    return d;
  }
  var candidateEnd = nextWeekdayAfter(candidateStart, 1, 8, 0);
  if(candidateEnd <= now){
    candidateStart.setDate(candidateStart.getDate() + 7);
    daysUntilSunday = (0 - candidateStart.getDay() + 7) % 7;
    sleepStart = new Date(candidateStart.getTime());
    sleepStart.setDate(candidateStart.getDate() + daysUntilSunday);
    sleepStart.setHours(22,0,0,0);
    candidateEnd = nextWeekdayAfter(candidateStart, 1, 8, 0);
  }

  var startDate = candidateStart;
  var endDate = candidateEnd;

  // slices
  var totalMs = endDate - startDate;
  var sliceMs = totalMs / 36;
  var labels = [], sliceStarts = [];
  for(var i=0;i<36;i++){
    var s = new Date(startDate.getTime() + Math.round(i * sliceMs));
    sliceStarts.push(s);
    labels.push(fmtLabel(s));
  }

  var dataArr = new Array(36).fill(1);
  var bgArr = new Array(36).fill(null);
  var borderArr = new Array(36).fill(getComputedStyle(document.documentElement).getPropertyValue('--dialBg') || '#0d1114');

  // patterns & gradients
  function makeSleepStripePattern(){
    var p = document.createElement('canvas'); p.width=12; p.height=12;
    var pctx = p.getContext('2d');
    pctx.fillStyle = '#eef1f5'; pctx.fillRect(0,0,12,12);
    pctx.strokeStyle = '#b7c0c8'; pctx.lineWidth = 3;
    pctx.beginPath(); pctx.moveTo(-2,10); pctx.lineTo(10,-2); pctx.stroke();
    pctx.beginPath(); pctx.moveTo(0,14); pctx.lineTo(14,0); pctx.stroke();
    pctx.strokeStyle='rgba(0,0,0,0.05)'; pctx.lineWidth=1; pctx.strokeRect(0.5,0.5,11,11);
    return ctx.createPattern(p,'repeat');
  }
  var sleepStripePattern = makeSleepStripePattern();

  function makeGradient(kind){
    var g = ctx.createLinearGradient(0,0,0,400);
    if(kind==='completed'){ g.addColorStop(0,'#004d2a'); g.addColorStop(1,'#00ff77'); }
    else if(kind==='current'){ g.addColorStop(0,'#00bfcf'); g.addColorStop(1,'#66ffff'); }
    else if(kind==='future'){ g.addColorStop(0,'#e6e6e6'); g.addColorStop(1,'#a9a9a9'); }
    else if(kind==='sleepDone'){ g.addColorStop(0,'#00bfcf'); g.addColorStop(1,'#66ffff'); }
    else if(kind==='sleepBase'){ g.addColorStop(0,'#eef2f6'); g.addColorStop(1,'#c8cfd6'); }
    else { g.addColorStop(0,'#330000'); g.addColorStop(1,'#550000'); }
    return g;
  }

  // compute currentIndex correctly (fatia que cont√©m "agora")
  var nowTime = new Date();
  var rawIndex = Math.floor((nowTime - startDate) / sliceMs);
  var currentIndex = rawIndex;
  if(isNaN(currentIndex) || currentIndex < 0) currentIndex = 0;
  if(currentIndex > 35) currentIndex = 35;

  // assign colors (ensuring currentIndex is ciano and previous are green)
  for(var i=0;i<36;i++){
    var s = sliceStarts[i];
    var inSleep = (s >= sleepStart && s < endDate);
    if(i < currentIndex){
      // passado
      bgArr[i] = inSleep ? makeGradient('sleepDone') : makeGradient('completed');
    } else if(i === currentIndex){
      // atual
      bgArr[i] = inSleep ? makeGradient('sleepDone') : makeGradient('current');
    } else {
      // futuro
      bgArr[i] = inSleep ? sleepStripePattern : makeGradient('future');
      if(bgArr[i] === sleepStripePattern) borderArr[i] = getComputedStyle(document.documentElement).getPropertyValue('--dialBg') || '#0d1114';
    }
  }

  // plugin: glow + central text (before draw)
  Chart.pluginService.register({
    beforeDraw: function(chart){
      var width = chart.chart.width, height = chart.chart.height, c = chart.chart.ctx;
      c.restore();
      c.save();
      c.globalCompositeOperation = 'lighter';
      var cx = width/2, cy = height/2;
      var grad = c.createRadialGradient(cx, cy, 0, cx, cy, Math.min(width,height)/2);
      grad.addColorStop(0, 'rgba(0,255,200,0.06)');
      grad.addColorStop(0.6,'rgba(0,255,200,0.01)');
      grad.addColorStop(1,'rgba(0,0,0,0)');
      c.fillStyle = grad;
      c.beginPath(); c.arc(cx, cy, Math.min(width,height)/2 * 0.62, 0, Math.PI*2); c.fill();
      c.restore();

      c.save();
      c.fillStyle = '#dffcff';
      var nowLabel = pad(nowTime.getHours())+':'+pad(nowTime.getMinutes());
      var fontSize = Math.round(height / 14);
      c.font = '600 ' + fontSize + 'px Inter, sans-serif';
      c.textAlign = 'center';
      c.textBaseline = 'middle';
      c.fillText('"' + nowLabel + '"', width/2, height/2 - 6);
      c.fillStyle = 'rgba(255,255,255,0.65)';
      c.font = '400 ' + Math.round(fontSize/2.5) + 'px Inter, sans-serif';
      c.fillText('Agora', width/2, height/2 + Math.round(fontSize/1.6));
      c.restore();
    }
  });

  // create chart (no seam-stroking plugin)
  var myChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: dataArr,
        backgroundColor: bgArr,
        borderWidth: 1,
        borderColor: borderArr,
        hoverBorderWidth: 1,
        hoverBorderColor: borderArr
      }]
    },
    options: {
      cutoutPercentage: 68,
      rotation: -Math.PI / 2,
      circumference: Math.PI * 2,
      responsive: false,
      legend: { display: false },
      tooltips: { enabled: false },
      animation: { animateScale: true, animateRotate: true },
      elements: { arc: { borderAlign: 'inner' } }
    }
  });

  // NEW: desenha m√°scara circular central *ap√≥s* o desenho do chart para esconder linhas internas
  Chart.pluginService.register({
    afterDraw: function(chart){
      try{
        var meta = chart.getDatasetMeta(0);
        if(!meta || !meta.data || !meta.data.length) return;
        // pega innerRadius do primeiro arco (todos compartilham)
        var innerR = meta.data[0]._model.innerRadius;
        var cx = chart.chart.width/2, cy = chart.chart.height/2;
        var c = chart.chart.ctx;
        c.save();
        // opcional: pequena margem para garantir cobertura
        var coverR = innerR + 1.5;
        // preenchimento que casa com o dial (um suave gradient)
        var g = c.createLinearGradient(0, cy - coverR, 0, cy + coverR);
        g.addColorStop(0,'#071014'); g.addColorStop(1,'#0d1114');
        c.fillStyle = g;
        c.beginPath();
        c.arc(cx, cy, coverR, 0, Math.PI*2);
        c.fill();
        c.restore();
      }catch(e){}
    }
  });

  // hover: emoji only on sleep-zone slices, positioned over the slice center
  var sleepEmoji = document.getElementById('sleepEmoji');
  function hideEmoji(){ sleepEmoji.classList.remove('visible'); sleepEmoji.setAttribute('aria-hidden','true'); }
  function showEmojiAtSlice(idx){
    var meta = myChart.getDatasetMeta(0);
    if(!meta || !meta.data[idx]) return hideEmoji();
    var arc = meta.data[idx]._model;
    var angle = (arc.startAngle + arc.endAngle) / 2;
    var r = arc.outerRadius * 0.78;
    var dx = Math.cos(angle) * r;
    var dy = Math.sin(angle) * r;
    sleepEmoji.style.transform = 'translate(-50%,-50%) translate(' + dx + 'px,' + dy + 'px)';
    sleepEmoji.classList.add('visible');
    sleepEmoji.setAttribute('aria-hidden','false');
  }

  canvasEl.addEventListener('mousemove', function(evt){
    var active = myChart.getElementAtEvent(evt);
    if(active && active.length){
      var idx = active[0]._index;
      if(idx !== undefined && idx >= 0 && idx < sliceStarts.length){
        var s = sliceStarts[idx];
        var inSleep = (s >= sleepStart && s < endDate);
        if(inSleep){ showEmojiAtSlice(idx); return; }
      }
    }
    hideEmoji();
  });
  canvasEl.addEventListener('mouseleave', hideEmoji);

  // button refresh
  document.getElementById('refreshBtn').addEventListener('click', function(){ location.reload(); });

  // remove native title
  document.getElementById('dialRoot').removeAttribute('title');

});
</script>
</body>
</html>
