<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Relógio — sleeping zone com nuvens</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0c0f; --muted:#cfd6dc; --dialBg:#0d1114;
  --greenStart:#004d2a; --greenEnd:#00ff77;
  --cyanStart:#00bfcf; --cyanEnd:#66ffff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; min-height:100vh; display:flex;align-items:center;justify-content:center;
  font-family:'Inter',system-ui,Roboto,Helvetica,Arial; background:linear-gradient(180deg,#060609,#0d0f11);
  color:var(--muted); padding:24px;
}
.bezel{ width:760px; max-width:95vw; padding:22px; border-radius:18px;
  background:linear-gradient(180deg,#0f1316,#17191c); box-shadow:0 12px 40px rgba(0,0,0,0.7); }
.glass{ border-radius:12px; padding:18px; display:flex; gap:20px; align-items:center; justify-content:space-between;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005)); backdrop-filter: blur(3px); }
.chart-wrap{width:420px;min-height:420px;display:flex;align-items:center;justify-content:center;padding:8px}
.dial{width:400px;height:400px;border-radius:50%;background:linear-gradient(180deg,#071014,#0d1114);box-shadow:inset 0 18px 40px rgba(0,0,0,0.6);position:relative;display:flex;align-items:center;justify-content:center}
canvas{display:block;border-radius:50%}
.controls{width:320px;display:flex;flex-direction:column;gap:12px}
.title{margin:0;font-size:20px;font-weight:600}
.sub{margin:6px 0 0 0;font-size:12px;color:rgba(207,214,220,0.72)}
.btn{padding:10px 14px;border-radius:10px;cursor:pointer;background:linear-gradient(180deg,#d7dbe0,#bfc6cc);box-shadow:0 6px 0 #6b6f73;border:1px solid rgba(0,0,0,0.12);font-weight:600}
.link-salario{display:inline-block;padding:8px 10px;border-radius:8px;text-decoration:none;font-weight:600;color:var(--cyanEnd)}
.meta{font-size:12px;color:rgba(207,214,220,0.6);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.legend-pill{display:inline-block;width:10px;height:10px;border-radius:50%;}
@media (max-width:900px){ .glass{flex-direction:column;align-items:center} .chart-wrap{width:100%} .controls{width:100%} .dial{width:320px;height:320px} }
</style>
</head>
<body>
  <div class="bezel" role="region" aria-label="painel relógio">
    <div class="glass">
      <div class="chart-wrap">
        <div class="dial" id="dialRoot">
          <canvas id="myChart" width="400" height="400" aria-hidden="false"></canvas>
        </div>
      </div>

      <div class="controls" role="group" aria-label="controles">
        <div>
          <h1 class="title">Período semanal — início: sex 17:00</h1>
          <p class="sub">Sleeping zones: sáb 00:00–09:00, dom 00:00–09:00, dom 22:00 → seg 08:00. Zona de sono: nuvens animadas.</p>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn" id="refreshBtn">⟳ Refresh</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <a class="link-salario" href="/salario.html" target="_blank" rel="noopener">Ir para Salário</a>
          <div class="meta" aria-hidden="true">
            <span class="legend-pill" style="background:linear-gradient(180deg,var(--greenStart),var(--greenEnd))"></span><small>Concluído (fora do sono)</small>
            <span style="width:8px"></span>
            <span class="legend-pill" style="background:linear-gradient(180deg,var(--cyanStart),var(--cyanEnd));"></span><small>Atual / Dormido</small>
            <span style="width:8px"></span>
            <span class="legend-pill" style="background:linear-gradient(180deg,#eef1f5,#c8cfd6);border:1px solid rgba(0,0,0,0.08)"></span><small>Pendente (sono)</small>
          </div>
        </div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){

  // ---------- helpers ----------
  function pad(n){ return n<10?('0'+n):(''+n); }
  function fmtLabel(d){ var days=['Dom','Seg','Ter','Qua','Qui','Sex','Sab']; return days[d.getDay()]+' '+pad(d.getHours())+':'+pad(d.getMinutes()); }
  var now = new Date();
  var ctx = document.getElementById('myChart').getContext('2d');
  if(ctx && 'imageSmoothingEnabled' in ctx) ctx.imageSmoothingEnabled = true;
  var canvasEl = document.getElementById('myChart');

  // ---------- compute week window (sex 17:00 -> próxima seg 08:00) and sleeping ranges ----------
  function dateThisWeek(targetDay,hour,min){
    var base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour||0, min||0,0,0);
    var diff = targetDay - base.getDay();
    base.setDate(base.getDate() + diff);
    base.setHours(hour||0,min||0,0,0);
    return base;
  }
  var candidateStart = dateThisWeek(5,17,0);
  if(candidateStart > now) candidateStart.setDate(candidateStart.getDate()-7);

  function nextWeekdayAfter(baseDate,targetDay,hour,min){
    var d = new Date(baseDate.getTime());
    var diff = (targetDay + 7 - d.getDay()) % 7;
    if(diff===0 && (d.getHours()>hour || (d.getHours()===hour && d.getMinutes()>=min))) diff = 7;
    d.setDate(d.getDate()+diff);
    d.setHours(hour||0,min||0,0,0);
    return d;
  }
  var candidateEnd = nextWeekdayAfter(candidateStart,1,8,0);
  if(candidateEnd <= now){
    candidateStart.setDate(candidateStart.getDate()+7);
    candidateEnd = nextWeekdayAfter(candidateStart,1,8,0);
  }

  function dateForWeekdayAfterStart(day,hour,min){
    var d = new Date(candidateStart.getTime());
    var diff = (day - d.getDay() + 7) % 7;
    d.setDate(d.getDate() + diff);
    d.setHours(hour||0,min||0,0,0);
    return d;
  }

  var sat00 = dateForWeekdayAfterStart(6,0,0), sat09 = new Date(sat00.getTime()); sat09.setHours(9,0,0,0);
  var sun00 = dateForWeekdayAfterStart(0,0,0), sun09 = new Date(sun00.getTime()); sun09.setHours(9,0,0,0);
  var sun22 = dateForWeekdayAfterStart(0,22,0), mon08 = nextWeekdayAfter(sun22,1,8,0);

  function normalizeRange(startD,endD){
    while(endD <= candidateStart){ startD.setDate(startD.getDate()+7); endD.setDate(endD.getDate()+7); }
    while(startD >= candidateEnd){ startD.setDate(startD.getDate()-7); endD.setDate(endD.getDate()-7); }
    return {start:new Date(startD.getTime()), end:new Date(endD.getTime())};
  }
  var r1 = normalizeRange(sat00,sat09), r2 = normalizeRange(sun00,sun09), r3 = normalizeRange(sun22,mon08);
  var sleepRanges = [r1,r2,r3];

  var startDate = candidateStart, endDate = candidateEnd;

  // ---------- slices ----------
  var totalMs = endDate - startDate;
  var sliceMs = totalMs / 36;
  var labels = [], sliceStarts = [];
  for(var i=0;i<36;i++){
    var s = new Date(startDate.getTime() + Math.round(i * sliceMs));
    sliceStarts.push(s); labels.push(fmtLabel(s));
  }

  var dataArr = new Array(36).fill(1);
  var bgArr = new Array(36).fill(null);
  var borderArr = new Array(36).fill(getComputedStyle(document.documentElement).getPropertyValue('--dialBg') || '#0d1114');

  function isInSleepRanges(d){
    for(var k=0;k<sleepRanges.length;k++){
      if(d >= sleepRanges[k].start && d < sleepRanges[k].end) return true;
    } return false;
  }

  function makeGradient(kind){
    var g = ctx.createLinearGradient(0,0,0,400);
    if(kind==='completed'){ g.addColorStop(0,'#004d2a'); g.addColorStop(1,'#00ff77'); }
    else if(kind==='current'){ g.addColorStop(0,'#00bfcf'); g.addColorStop(1,'#66ffff'); }
    else if(kind==='future'){ g.addColorStop(0,'#e6e6e6'); g.addColorStop(1,'#a9a9a9'); }
    else if(kind==='sleepDone'){ g.addColorStop(0,'#00bfcf'); g.addColorStop(1,'#66ffff'); }
    else { g.addColorStop(0,'#330000'); g.addColorStop(1,'#550000'); }
    return g;
  }

  var nowTime = new Date();
  var rawIndex = Math.floor((nowTime - startDate) / sliceMs);
  var currentIndex = rawIndex;
  if(isNaN(currentIndex) || currentIndex < 0) currentIndex = 0;
  if(currentIndex > 35) currentIndex = 35;

  // ---------- CLOUD PATTERN (seamless tile drawn on offscreen canvas) ----------
  var tile = 48; // tile size (px) — ajuste para densidade
  var patternCanvas = document.createElement('canvas'); patternCanvas.width = tile; patternCanvas.height = tile;
  var pctx = patternCanvas.getContext('2d');

  // função que desenha nuvens no tile, usando phase para movimento/pulsação
  function drawCloudTile(phase){
    pctx.clearRect(0,0,tile,tile);
    // base (lembra tom do sleep background)
    pctx.fillStyle = '#efeff1';
    pctx.fillRect(0,0,tile,tile);

    // params para 3 nuvens por tile (posições relativas)
    var clouds = [
      {x: tile*0.25, y: tile*0.45, s: tile*0.42, o: 0.08},
      {x: tile*0.62, y: tile*0.32, s: tile*0.5, o: 0.15},
      {x: tile*0.72, y: tile*0.68, s: tile*0.38, o: -0.12}
    ];

    // pequena oscilação horizontal por phase (faz o padrão "respirar")
    var shift = Math.sin(phase * Math.PI * 2) * (tile * 0.06); // <= ajuste amplitude

    // desenha nuvens com sombras internas
    clouds.forEach(function(c, idx){
      var cx = c.x + ((idx%2===0)? shift : -shift * 0.6);
      var cy = c.y + Math.cos(phase * Math.PI * 2 + idx) * (tile*0.02);
      var s = c.s;
      // sombra
      pctx.fillStyle = 'rgba(6,10,12,0.08)';
      pctx.beginPath();
      pctx.ellipse(cx+3, cy+4, s*0.55, s*0.38, 0, 0, Math.PI*2);
      pctx.fill();
      // formas básicas de nuvem (sobreposição de círculos)
      pctx.fillStyle = 'rgba(255,255,255,' + (0.7 + 0.15 * Math.sin(phase * Math.PI*2 + idx)) + ')';
      var r = s * 0.33;
      pctx.beginPath();
      pctx.arc(cx - r*0.6, cy, r, 0, Math.PI*2);
      pctx.arc(cx, cy - r*0.2, r*1.05, 0, Math.PI*2);
      pctx.arc(cx + r*0.6, cy, r, 0, Math.PI*2);
      pctx.closePath();
      pctx.fill();
      // suaviza contorno com stroke leve
      pctx.strokeStyle = 'rgba(200,200,200,0.08)';
      pctx.lineWidth = 0.6;
      pctx.stroke();
    });

    // opcional textura leve: linhas diagonais sutis (para distinguir do cinza plano)
    pctx.strokeStyle = 'rgba(20,22,24,0.02)';
    pctx.lineWidth = 1;
    for(var y= -tile; y < tile*2; y += 12){
      pctx.beginPath();
      pctx.moveTo(-tile, y);
      pctx.lineTo(tile*2, y + tile);
      pctx.stroke();
    }
  }

  // desenha primeira versão
  drawCloudTile(0);
  var cloudPattern = ctx.createPattern(patternCanvas, 'repeat');

  // ---------- assign backgrounds ----------
  for(var i=0;i<36;i++){
    var s = sliceStarts[i];
    var inSleep = isInSleepRanges(s);
    if(i < currentIndex){
      bgArr[i] = inSleep ? makeGradient('sleepDone') : makeGradient('completed');
    } else if(i === currentIndex){
      bgArr[i] = inSleep ? makeGradient('sleepDone') : makeGradient('current');
    } else {
      if(inSleep){
        bgArr[i] = cloudPattern;
        borderArr[i] = getComputedStyle(document.documentElement).getPropertyValue('--dialBg') || '#0d1114';
      } else {
        bgArr[i] = makeGradient('future');
      }
    }
  }

  // ---------- Chart + plugins ----------
  Chart.pluginService.register({
    beforeDraw: function(chart){
      var width = chart.chart.width, height = chart.chart.height, c = chart.chart.ctx;
      c.restore(); c.save();
      c.globalCompositeOperation = 'lighter';
      var cx = width/2, cy = height/2;
      var grad = c.createRadialGradient(cx, cy, 0, cx, cy, Math.min(width,height)/2);
      grad.addColorStop(0, 'rgba(0,255,200,0.06)'); grad.addColorStop(0.6,'rgba(0,255,200,0.01)'); grad.addColorStop(1,'rgba(0,0,0,0)');
      c.fillStyle = grad; c.beginPath(); c.arc(cx, cy, Math.min(width,height)/2 * 0.62, 0, Math.PI*2); c.fill();
      c.restore();

      c.save();
      c.fillStyle = '#dffcff';
      var nowLabel = pad(nowTime.getHours())+':'+pad(nowTime.getMinutes());
      var fontSize = Math.round(height / 14);
      c.font = '600 ' + fontSize + 'px Inter, sans-serif';
      c.textAlign = 'center'; c.textBaseline = 'middle';
      c.fillText('"' + nowLabel + '"', width/2, height/2 - 6);
      c.fillStyle = 'rgba(255,255,255,0.65)';
      c.font = '400 ' + Math.round(fontSize/2.5) + 'px Inter, sans-serif';
      c.fillText('Agora', width/2, height/2 + Math.round(fontSize/1.6));
      c.restore();
    }
  });

  var myChart = new Chart(ctx, {
    type: 'doughnut',
    data: { labels: labels, datasets: [{ data: dataArr, backgroundColor: bgArr, borderWidth: 1, borderColor: borderArr }] },
    options: {
      cutoutPercentage: 68, rotation: -Math.PI/2, circumference: Math.PI*2,
      responsive:false, legend:{display:false}, tooltips:{enabled:false},
      animation:{animateScale:true,animateRotate:true}, elements:{ arc: { borderAlign: 'inner' } }
    }
  });

  // central mask para esconder seams
  Chart.pluginService.register({
    afterDraw: function(chart){
      try{
        var meta = chart.getDatasetMeta(0);
        if(!meta || !meta.data || !meta.data.length) return;
        var innerR = meta.data[0]._model.innerRadius;
        var cx = chart.chart.width/2, cy = chart.chart.height/2;
        var c = chart.chart.ctx;
        c.save();
        var coverR = innerR + 1.5;
        var g = c.createLinearGradient(0, cy - coverR, 0, cy + coverR);
        g.addColorStop(0,'#071014'); g.addColorStop(1,'#0d1114');
        c.fillStyle = g;
        c.beginPath(); c.arc(cx, cy, coverR, 0, Math.PI*2); c.fill();
        c.restore();
      }catch(e){}
    }
  });

  // ---------- animation loop: atualiza tile (movimento + pulso) e redesenha slices de sleep-future ----------
  var animStart = performance.now(); var lastUpdate = 0;
  function animate(t){
    var elapsed = (t - animStart) / 1000;
    var phase = (elapsed * 0.55) % 1.0; // velocidade; diminua para mais lento
    drawCloudTile(phase);
    cloudPattern = ctx.createPattern(patternCanvas, 'repeat');
    for(var i=0;i<36;i++){
      var s = sliceStarts[i];
      if(isInSleepRanges(s) && i > currentIndex){
        myChart.data.datasets[0].backgroundColor[i] = cloudPattern;
      }
    }
    if(t - lastUpdate > 33){ try{ myChart.update(0); }catch(e){} lastUpdate = t; }
    requestAnimationFrame(animate);
  }
  requestAnimationFrame(animate);

  // refresh
  document.getElementById('refreshBtn').addEventListener('click', function(){ location.reload(); });

  // remove native title
  document.getElementById('dialRoot').removeAttribute('title');

}); // DOMContentLoaded
</script>
</body>
</html>
