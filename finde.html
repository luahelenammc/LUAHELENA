<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rel√≥gio ‚Äî fim de semana / sleep zone</title>
<link rel="icon" type="image/x-icon" href="/images/briefcase.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0c0f; --muted:#cfd6dc; --accent2:#00ff77; --accent1:#00ffff;
    --sleepGray1:#dfe3e6; --sleepGray2:#a7adb1;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
    font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial;
    background:linear-gradient(180deg,#060609,#0d0f11); color:var(--muted); padding:28px;
  }

  .bezel{ width:760px; max-width:95vw; padding:22px; border-radius:18px;
    background:linear-gradient(180deg,#0f1316,#17191c); box-shadow:0 12px 40px rgba(0,0,0,0.7); position:relative; }
  .glass{ border-radius:12px; padding:18px; display:flex; gap:20px; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005)); backdrop-filter: blur(3px); position:relative; }
  .screw{position:absolute;width:12px;height:12px;border-radius:50%;background:linear-gradient(145deg,#ddd,#888);border:1px solid rgba(0,0,0,0.2)}
  .s1{left:12px;top:12px}.s2{right:12px;top:12px}.s3{left:12px;bottom:12px}.s4{right:12px;bottom:12px}

  .chart-wrap{width:420px;min-height:420px;display:flex;align-items:center;justify-content:center;padding:8px}
  .dial{width:400px;height:400px;border-radius:50%;background:linear-gradient(180deg,#071014,#0d1114);box-shadow:inset 0 18px 40px rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;position:relative}
  canvas{display:block;border-radius:50%}

  /* emoji de sono sobreposto */
  .sleep-emoji{
    position:absolute;
    right:18%;
    top:18%;
    font-size:34px;
    filter: drop-shadow(0 6px 10px rgba(0,0,0,0.6));
    opacity:0;
    pointer-events:none;
    transform-origin:center;
    animation: sleepFade 2.6s ease-in-out infinite;
    will-change:opacity, transform;
  }
  @keyframes sleepFade{
    0%{opacity:0; transform:translateY(-6px) scale(0.96)}
    10%{opacity:0.9; transform:translateY(0) scale(1)}
    50%{opacity:0.6; transform:translateY(-4px) scale(0.98)}
    90%{opacity:0.9; transform:translateY(0) scale(1)}
    100%{opacity:0; transform:translateY(-6px) scale(0.96)}
  }

  .controls{width:280px;display:flex;flex-direction:column;gap:14px}
  .title{margin:0;font-size:20px;font-weight:600}
  .sub{margin:6px 0 0 0;font-size:12px;color:rgba(207,214,220,0.72)}
  .btn{padding:12px 16px;border-radius:12px;cursor:pointer;background:linear-gradient(180deg,#d7dbe0,#bfc6cc);box-shadow:0 6px 0 #6b6f73;border:1px solid rgba(0,0,0,0.15);font-weight:600}
  .btn.secondary{background:linear-gradient(180deg,#1a1f24,#0f1417);color:var(--muted);box-shadow:0 8px 18px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
  .link-salario{display:inline-block;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:600;color:var(--accent1)}
  .meta{font-size:12px;color:rgba(207,214,220,0.6);display:flex;gap:8px;align-items:center}
  .legend-pill{display:inline-block;width:10px;height:10px;border-radius:50%;}

  @media (max-width:900px){
    .glass{flex-direction:column;align-items:center}
    .chart-wrap{width:100%}
    .controls{width:100%}
    .dial{width:320px;height:320px}
    .sleep-emoji{right:12%; top:12%; font-size:28px}
  }
</style>
</head>
<body>

  <div class="bezel" role="region" aria-label="painel rel√≥gio">
    <div class="screw s1" aria-hidden="true"></div><div class="screw s2" aria-hidden="true"></div>
    <div class="screw s3" aria-hidden="true"></div><div class="screw s4" aria-hidden="true"></div>

    <div class="glass">
      <div class="chart-wrap">
        <div class="dial" id="dialRoot">
          <canvas id="myChart" width="400" height="400"></canvas>
          <div id="sleepEmoji" class="sleep-emoji" aria-hidden="true">üò¥</div>
        </div>
      </div>

      <div class="controls" role="group" aria-label="controles">
        <div><h1 class="title">Per√≠odo: fim de sexta ‚Üí segunda manh√£</h1><p class="sub">36 fatias ‚Ä¢ √°rea cinza = hora de dormir (domingo 22h ‚Üí seg 08h)</p></div>

        <div style="display:flex;gap:10px">
          <button class="btn" id="refreshBtn">‚ü≥ Refresh</button>
          <button class="btn secondary" id="toggleLegend">‚Ä¢‚Ä¢</button>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <a class="link-salario" href="#" target="_blank" rel="noopener">X</a>
          <div class="meta">
            <span class="legend-pill" style="background:linear-gradient(180deg,#004d2a,#00ff77)"></span><small>Conclu√≠do</small>
            <span class="legend-pill" style="background:linear-gradient(180deg,#00bfcf,#66ffff);margin-left:8px"></span><small>Atual</small>
            <span class="legend-pill" style="background:linear-gradient(180deg,var(--sleepGray1),var(--sleepGray2));margin-left:8px"></span><small>Zona de sono</small>
          </div>
        </div>

        <div style="margin-top:auto;font-size:11px;color:rgba(207,214,220,0.55)"><small>Design: anel com gradientes ‚Ä¢ mesma l√≥gica intacta</small></div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function(){

  // helper de formata√ß√£o
  function pad(n){ return n<10?('0'+n):(''+n); }
  function fmtLabel(d){
    var days = ['Dom','Seg','Ter','Qua','Qui','Sex','Sab'];
    return days[d.getDay()]+' '+pad(d.getHours())+':'+pad(d.getMinutes());
  }

  var ctx = document.getElementById('myChart').getContext('2d');

  // ====== calcula start / preEnd / end para o per√≠odo semanal desejado
  var now = new Date();

  // retorna um Date para o dia-da-semana 'targetDay' (0=Sun..6=Sat) desta semana com hora/h,min
  function dateThisWeek(targetDay, hour, min){
    var d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour||0, min||0, 0, 0);
    var diff = targetDay - d.getDay();
    d.setDate(d.getDate() + diff);
    d.setHours(hour||0, min||0, 0, 0);
    return d;
  }

  // queremos: start = sexta(5) 17:00 ; sleepStart = domingo(0) 22:00 ; end = segunda(1) 08:00 (following Monday)
  var candidateStart = dateThisWeek(5,17,0); // this week's Friday 17:00
  // if candidateStart > now -> move to previous week
  if(candidateStart > now) candidateStart.setDate(candidateStart.getDate() - 7);

  function nextWeekdayFrom(dateObj, targetDay, hour, min){
    // find next targetDay after dateObj (could be same week)
    var d = new Date(dateObj.getTime());
    var diff = (targetDay + 7 - d.getDay()) % 7;
    if(diff === 0 && (d.getHours() > hour || (d.getHours()===hour && d.getMinutes()>=min))) diff = 7; // ensure strictly after if same day but later/equal
    d.setDate(d.getDate() + diff);
    d.setHours(hour||0, min||0, 0, 0);
    return d;
  }

  // compute end and preEnd relative to candidateStart
  var candidatePreEnd = new Date(candidateStart.getTime());
  candidatePreEnd.setDate(candidateStart.getDate() + ((0 + 7 - candidateStart.getDay()) % 7)); // Sunday of that range
  candidatePreEnd.setHours(22,0,0,0);

  var candidateEnd = nextWeekdayFrom(candidateStart, 1, 8, 0); // next Monday 08:00 after candidateStart

  // if the candidateEnd is in the past (i.e., the period passed), shift start to next Friday
  if(candidateEnd <= now) {
    candidateStart.setDate(candidateStart.getDate() + 7);
    candidatePreEnd = new Date(candidateStart.getTime());
    candidatePreEnd.setDate(candidateStart.getDate() + ((0 + 7 - candidateStart.getDay()) % 7));
    candidatePreEnd.setHours(22,0,0,0);
    candidateEnd = nextWeekdayFrom(candidateStart, 1, 8, 0);
  }

  var startDate = candidateStart;
  var preEndDate = candidatePreEnd;
  var endDate = candidateEnd;

  // precalc total minutes and per-slice minutes
  var totalMs = endDate - startDate;
  var totalMinutes = totalMs / 60000;
  var sliceMinutes = totalMinutes / 36;

  // build labels evenly spaced across period (slice start times)
  var labels = [];
  var sliceStarts = [];
  for(var i=0;i<36;i++){
    var s = new Date(startDate.getTime() + Math.round(i * sliceMinutes * 60000));
    sliceStarts.push(s);
    labels.push(fmtLabel(s));
  }

  // initialize data arrays
  var dataArr = new Array(36).fill(0);
  var bgArr = new Array(36).fill(null);

  // gradients factory
  function makeGradient(kind){
    var g = ctx.createLinearGradient(0,0,0,400);
    if(kind==='completed'){ g.addColorStop(0,'#004d2a'); g.addColorStop(1,'#00ff77'); }
    else if(kind==='current'){ g.addColorStop(0,'#00bfcf'); g.addColorStop(1,'#66ffff'); }
    else if(kind==='future'){ g.addColorStop(0,'#e6e6e6'); g.addColorStop(1,'#a9a9a9'); }
    else if(kind==='sleep'){ g.addColorStop(0,'#f0f3f5'); g.addColorStop(1,'#bfc5c9'); }
    else { g.addColorStop(0,'#330000'); g.addColorStop(1,'#550000'); }
    return g;
  }

  // compute intervalsElapsed relative to startDate (clamp to [0,36])
  var nowTime = new Date();
  var elapsedMs = nowTime - startDate;
  var intervalsElapsed = Math.floor(elapsedMs / (sliceMinutes * 60000));
  if(isNaN(intervalsElapsed) || intervalsElapsed < 0) intervalsElapsed = 0;
  if(intervalsElapsed > 36) intervalsElapsed = 36;

  // assign slice types
  for(var i=0;i<36;i++){
    var sliceStart = sliceStarts[i];
    var sliceEnd = new Date(sliceStart.getTime() + sliceMinutes*60000);

    // sleep zone slices: those that start >= preEndDate AND start < endDate
    var isSleepSlice = (sliceStart >= preEndDate && sliceStart < endDate);

    if(isSleepSlice){
      bgArr[i] = makeGradient('sleep');
      dataArr[i] = 1;
    } else {
      // before or after relative to now
      if(i < intervalsElapsed){
        // passed
        // the last passed (i == intervalsElapsed-1) we mark as current later
        bgArr[i] = makeGradient('completed');
        dataArr[i] = 1;
      } else {
        // future (not yet reached)
        bgArr[i] = makeGradient('future');
        dataArr[i] = 1;
      }
    }
  }

  // adjust current slice (the most recent completed one) to be 'current' color (ciano),
  // but avoid overriding the sleep zone color if current slice lies inside sleep zone.
  var currentIndex = Math.max(0, intervalsElapsed - 1);
  if(currentIndex < 36){
    var sst = sliceStarts[currentIndex];
    if(!(sst >= preEndDate && sst < endDate)){ // if not inside sleep zone
      bgArr[currentIndex] = makeGradient('current');
    }
  }

  // register plugin: central text + subtle glass glow
  Chart.pluginService.register({
    beforeDraw: function(chart){
      var width = chart.chart.width, height = chart.chart.height, ctx = chart.chart.ctx;
      ctx.restore();

      // glow
      ctx.save();
      ctx.globalCompositeOperation = 'lighter';
      var cx = width/2, cy = height/2;
      var grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, Math.min(width,height)/2);
      grad.addColorStop(0, 'rgba(0,255,200,0.06)'); grad.addColorStop(0.6,'rgba(0,255,200,0.01)'); grad.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(cx, cy, Math.min(width,height)/2 * 0.62, 0, Math.PI*2); ctx.fill();
      ctx.restore();

      // central text: show current timestamp and period info
      ctx.save();
      ctx.fillStyle = '#dffcff';
      var nowLabel = pad(nowTime.getHours())+':'+pad(nowTime.getMinutes());
      var fontSize = Math.round(height / 14);
      ctx.font = '600 ' + fontSize + 'px Inter, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('"' + nowLabel + '"', width/2, height/2 - 6);

      ctx.fillStyle = 'rgba(255,255,255,0.65)';
      ctx.font = '400 ' + Math.round(fontSize/2.5) + 'px Inter, sans-serif';
      ctx.fillText('Agora', width/2, height/2 + Math.round(fontSize/1.6));

      ctx.restore();
    }
  });

  // create doughnut chart
  var myChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: dataArr,
        backgroundColor: bgArr,
        borderWidth: 2,
        borderColor: '#0b0c0f'
      }]
    },
    options: {
      cutoutPercentage: 68,
      rotation: -Math.PI / 2,
      circumference: Math.PI * 2,
      responsive: false,
      legend: { display: false },
      tooltips: { enabled: false },
      animation: { animateScale: true, animateRotate: true },
      elements: { arc: { borderAlign: 'inner' } }
    }
  });

  // show/hide emoji depending on now inside sleep zone (preEnd -> end)
  var sleepEmoji = document.getElementById('sleepEmoji');
  function updateSleepEmojiVisibility(){
    var nowt = new Date();
    if(nowt >= preEndDate && nowt < endDate){
      sleepEmoji.style.opacity = '1'; // animation handles fade
      sleepEmoji.setAttribute('aria-hidden','false');
    } else {
      sleepEmoji.style.opacity = '0';
      sleepEmoji.setAttribute('aria-hidden','true');
    }
  }
  updateSleepEmojiVisibility();

  // buttons
  document.getElementById('refreshBtn').addEventListener('click', function(){ location.reload(); });
  document.getElementById('toggleLegend').addEventListener('click', function(){
    var dial = document.getElementById('dialRoot');
    dial.style.boxShadow = dial.style.boxShadow ? '' : 'inset 0 22px 44px rgba(0,255,200,0.02), 0 18px 36px rgba(0,255,120,0.02)';
  });

  // small accessibility: tooltip as title with precise period timestamps
  var dialRoot = document.getElementById('dialRoot');
  dialRoot.title = 'Per√≠odo de contagem: ' + startDate.toLocaleString() + ' ‚Üí ' + endDate.toLocaleString() + '\nZona de sono come√ßa: ' + preEndDate.toLocaleString();

});
</script>

</body>
</html>
